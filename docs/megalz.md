# Формат пакованного файла MegaLZ

*Из журнала Info Guide #10, Рязань, 05.2007, by Lord Vader, редактирование
и перевод в формат Markdown — ruguevara.*

Первый байт копируется в выход, второй — идёт в биты.

Биты в байте битов со старшего. Если нужен бит, а его уже нет (все 8
кончились) - то новый байт выбирается из потока. Оттуда же выбираются и байты,
обозначенные `<byte>`  но только после выборки всех битов ссылки.

В кодах `<byte>` обозначает байт, который выбирается из байтового потока, всё
остальное перется из битового потока.

Смещения ссылок берутся от текущей позиции вывода, например смещение `#FFFF == -1`
означает скопировать байты начиная с позиции слева от текущей.

## Виды управляющих кодов

1. копировать в выход литерал длиной 1 байт
2. ссылка длиной 1 байт,     смещения FFF8..FFFF (-1..-8)
3. ссылка длиной 2 байта,    смещения FF00..FFFF (-1..-256)
4. ccылки длиной 3-255 байт, смещения EF00..FFFF (-1..-4352)
5. конец потока

| Код              | Значение длины ссылки                                                                                   |
|------------------|---------------------------------------------------------------------------------------------------------|
| `1<byte>`        | копировать `<byte>` в выход                                                                             |
| `000abc`         | копировать 1 байт по смещению FFF8+[abc] от текущей позиции (abc==000 — смещение FFF8, abc==111 — FFFF) |
| `001<byte>`      | копировать 2 байта по смещению FF00+`<byte>` (-1..-256)                                                 |
| `0100<byte>`     | копировать 3 байта по смещению FF00+`<byte>` (-1..-256)                                                 |
| `0101abcd<byte>` | копировать 3 байта по смещению (F0+[abcd]-1) * 256 + `<byte>` (-257..-4352)                             |
| `011`            | длинная ссылка, см. ниже                                                                                |

## Длинные ссылки

Длинные ссылки удобно представить в виде трёх частей:

* префикс `011`;
* длина ссылки, кодируется кодом переменной длины;
* смещение, кодируется двумя вариантами битового кода (`0` или `1abcd`) и одним байтом из байтового потока

### Длина ссылки

| Код            | Значение длины ссылки                        |
|----------------|----------------------------------------------|
|`1a`            | 4+[a]                                        |
|`01ab`          | 6+[ab]                                       |
|`001abc`        | 10+[abc]                                     |
|`0001abcd`      | 18+[abcd]                                    |
|`00001abcde`    | 34+[abcde]                                   |
|`000001abcdef`  | 66+[abcdef]                                  |
|`0000001abcdefg`| 130+[abcdefg], но не более 255               |
|`000000001`     | не ссылка, а конец потока                    |

### Смещение

| Код            | Значение смещения                            |
|----------------|----------------------------------------------|
| `0<byte>`      | FF00+`<byte>` (-1..-256)                     |
| `1abcd<byte>`  | (F0+[abcd]-1) * 256 + `<byte>` (-257..-4352) |

## Метка конца потока

`011000000001`

## Примеры

`000111` — повторить последний байт

`001<byte=FF>` — повторить последний байт дважды (смещение `-1`, длина `2`)

`011 001101 10000<byte=0>` — ссылка длиной `10+%101` = 15 байт со смещением
(F0+0-1) * 256 = EF00 = -4352
